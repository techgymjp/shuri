<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹è£å‰£ã‚·ãƒ¥ã‚·ãƒ¥ã‚·ãƒ¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            overflow: hidden;
            user-select: none;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #groundBackground {
            position: absolute;
            top: -500vh;
            left: 0;
            width: 100%;
            height: 600vh;
            background: #8FBC8F; /* åœ°é¢ã®åŸºæœ¬è‰² */
            z-index: 0;
            transition: transform 0.1s ease-out;
        }

        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 500%;
            background: linear-gradient(180deg, 
                #000428 0%, 
                #004e92 10%, 
                #009ffd 20%, 
                #00d2ff 30%, 
                #87CEEB 40%, 
                #87CEEB 50%, 
                rgba(135, 206, 235, 0.3) 60%, 
                rgba(152, 251, 152, 0.2) 70%, 
                rgba(240, 230, 140, 0.1) 80%, 
                transparent 90%, 
                transparent 100%);
            z-index: 1;
            transition: transform 0.1s ease-out;
        }

        .ground-element {
            position: absolute;
        }

        .field {
            background: linear-gradient(45deg, #90EE90, #98FB98);
            border: 2px solid #228B22;
            border-radius: 10px;
        }

        .rice-field {
            background: linear-gradient(45deg, #ADFF2F, #9ACD32);
            border: 1px solid #6B8E23;
        }

        .river {
            background: linear-gradient(90deg, #4169E1, #1E90FF, #87CEEB);
            border-radius: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .house {
            background: #D2691E;
            position: relative;
        }

        .house::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -5px;
            width: calc(100% + 10px);
            height: 20px;
            background: #8B4513;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .road {
            background: #696969;
            border-left: 2px dashed #FFFFFF;
            border-right: 2px dashed #FFFFFF;
        }

        .forest {
            background: radial-gradient(circle, #228B22, #006400);
            border-radius: 50%;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.7;
            z-index: 2;
        }

        .cloud:before {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50px;
        }

        /* åˆæœŸé›²ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ç”»é¢ä¸Šéƒ¨ã«é…ç½®ï¼‰ */
        .cloud1 {
            width: 60px;
            height: 30px;
            top: -100px;
            left: 20%;
        }

        .cloud1:before {
            width: 40px;
            height: 40px;
            top: -20px;
            left: 10px;
        }

        .cloud2 {
            width: 80px;
            height: 40px;
            top: -150px;
            left: 70%;
        }

        .cloud2:before {
            width: 60px;
            height: 60px;
            top: -30px;
            left: 20px;
        }

        .cloud3 {
            width: 100px;
            height: 50px;
            top: -200px;
            left: 40%;
        }

        .cloud3:before {
            width: 80px;
            height: 80px;
            top: -40px;
            left: 20px;
        }

        #shuriken {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            z-index: 10;
            transition: none;
        }

        .shuriken-star {
            width: 100%;
            height: 100%;
            background: #333;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .rotating {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 20px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 30px 45px;
            border-radius: 15px;
            max-width: 90%;
            min-width: 400px;
            width: auto;
        }

        #instructions h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #FFD700;
        }

        #instructions p {
            font-size: 1.2em;
            margin: 10px 0;
            line-height: 1.5;
        }

        #startButton {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: transform 0.2s;
        }

        #startButton:hover {
            transform: translateY(-2px);
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            display: none;
        }

        #distance {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        #maxDistance {
            font-size: 1.2em;
            color: #FFD700;
            margin-bottom: 20px;
        }

        #restartButton {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
            transition: transform 0.2s;
        }

        #restartButton:hover {
            transform: translateY(-2px);
        }

        #accelerationDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 16px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #FFD700, transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="groundBackground"></div>
        <div id="background">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            <div class="cloud cloud3"></div>
            <div class="cloud cloud4"></div>
            <div class="cloud cloud5"></div>
            <div class="cloud cloud6"></div>
            <div class="cloud cloud7"></div>
            <div class="cloud cloud8"></div>
            <div class="cloud cloud9"></div>
            <div class="cloud cloud10"></div>
            <div class="cloud cloud11"></div>
            <div class="cloud cloud12"></div>
            <div class="cloud cloud13"></div>
            <div class="cloud cloud14"></div>
            <div class="cloud cloud15"></div>
        </div>

        <div id="instructions">
            <h1>ğŸ¥· æ‰‹è£å‰£ã‚·ãƒ¥ã‚·ãƒ¥ã‚·ãƒ¥ ğŸ¥·</h1>
            <p>ğŸ“± iPhoneã®å ´åˆã€åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™</p>
            <p>ãƒ‡ãƒã‚¤ã‚¹ã‚’æ°´å¹³ã«æŒã£ã¦ã€æ¨ªã«ç´ æ—©ãæŒ¯ã£ã¦ãã ã•ã„ï¼</p>
            <p>åŠ é€Ÿåº¦ã«å¿œã˜ã¦æ‰‹è£å‰£ãŒé ãã¾ã§é£›ã³ã¾ã™</p>
            <p>æœ€é«˜è¨˜éŒ²ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼</p>
            <button id="startButton">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <div id="ui">
            <div id="distance">è·é›¢: 0m</div>
            <div id="maxDistance">æœ€é«˜è¨˜éŒ²: 0m</div>
        </div>

        <div id="shuriken">
            <div class="shuriken-star"></div>
        </div>

        <div id="gameOver">
            <h2>ğŸ¯ çµæœç™ºè¡¨ ğŸ¯</h2>
            <div id="finalDistance">è·é›¢: 0m</div>
            <div id="newRecord" style="display: none; color: #FFD700; font-size: 1.5em; margin: 10px 0;">ğŸ‰ æ–°è¨˜éŒ²ï¼ ğŸ‰</div>
            <button id="restartButton">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        </div>

        <div id="accelerationDisplay">
            <div>åŠ é€Ÿåº¦ X: <span id="accelX">0</span></div>
            <div>åŠ é€Ÿåº¦ Y: <span id="accelY">0</span></div>
            <div>åŠ é€Ÿåº¦ Z: <span id="accelZ">0</span></div>
        </div>
    </div>

    <script>
        class ShurikenGame {
            constructor() {
                this.shuriken = document.getElementById('shuriken');
                this.background = document.getElementById('background');
                this.distanceDisplay = document.getElementById('distance');
                this.maxDistanceDisplay = document.getElementById('maxDistance');
                this.instructions = document.getElementById('instructions');
                this.gameOver = document.getElementById('gameOver');
                this.startButton = document.getElementById('startButton');
                this.restartButton = document.getElementById('restartButton');
                
                this.accelXDisplay = document.getElementById('accelX');
                this.accelYDisplay = document.getElementById('accelY');
                this.accelZDisplay = document.getElementById('accelZ');
                
                this.isPlaying = false;
                this.distance = 0;
                this.velocity = 0;
                this.maxDistance = parseInt(localStorage.getItem('maxDistance')) || 0;
                this.lastAcceleration = { x: 0, y: 0, z: 0 };
                this.throwTriggered = false;
                this.animationId = null;
                this.trails = [];
                this.backgroundOffset = 0;
                this.groundOffset = 0;
                this.shurikenScale = 1;
                this.altitude = 0;
                this.clouds = [];
                this.cloudSpeed = 8; // é›²ã®é€Ÿåº¦
                this.groundSpeed = 3; // åœ°ä¸ŠèƒŒæ™¯ã®é€Ÿåº¦ï¼ˆé›²ã‚ˆã‚Šé…ã„ï¼‰
                this.groundElements = [];
                
                // éŸ³å£°é–¢é€£
                this.audioContext = null;
                this.sounds = {};
                
                this.maxDistanceDisplay.textContent = `æœ€é«˜è¨˜éŒ²: ${this.maxDistance}m`;
                
                this.bindEvents();
                this.initAudio();
                this.initClouds();
                this.initGroundBackground();
            }

            initClouds() {
                // æ—¢å­˜ã®é›²ã‚’cloudsé…åˆ—ã«è¿½åŠ 
                this.clouds = Array.from(document.querySelectorAll('.cloud'));
            }

            initGroundBackground() {
                this.groundBackground = document.getElementById('groundBackground');
                this.createGroundElements();
            }

            createGroundElements() {
                const windowHeight = window.innerHeight;
                const windowWidth = window.innerWidth;
                
                // ç”°åœ’é¢¨æ™¯è¦ç´ ã‚’ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦é…ç½®
                const elements = [
                    // ç”°ç•‘ - ã‚ˆã‚Šå¤šãé…ç½®
                    { type: 'field', x: 0.1, y: 500, w: 0.15, h: 80 },
                    { type: 'field', x: 0.2, y: 450, w: 0.18, h: 90 },
                    { type: 'rice-field', x: 0.4, y: 480, w: 0.2, h: 70 },
                    { type: 'field', x: 0.65, y: 460, w: 0.15, h: 100 },
                    { type: 'rice-field', x: 0.85, y: 520, w: 0.12, h: 60 },
                    
                    { type: 'field', x: 0.05, y: 350, w: 0.22, h: 85 },
                    { type: 'rice-field', x: 0.3, y: 320, w: 0.18, h: 95 },
                    { type: 'field', x: 0.55, y: 340, w: 0.2, h: 75 },
                    { type: 'rice-field', x: 0.8, y: 380, w: 0.17, h: 80 },
                    
                    { type: 'field', x: 0.1, y: 200, w: 0.16, h: 90 },
                    { type: 'rice-field', x: 0.35, y: 180, w: 0.2, h: 100 },
                    { type: 'field', x: 0.6, y: 220, w: 0.18, h: 70 },
                    { type: 'rice-field', x: 0.85, y: 250, w: 0.13, h: 85 },
                    
                    { type: 'field', x: 0.02, y: 50, w: 0.2, h: 95 },
                    { type: 'rice-field', x: 0.25, y: 80, w: 0.15, h: 80 },
                    { type: 'field', x: 0.45, y: 30, w: 0.22, h: 110 },
                    { type: 'rice-field', x: 0.7, y: 90, w: 0.18, h: 75 },
                    
                    // å· - è›‡è¡Œã™ã‚‹å·
                    { type: 'river', x: 0, y: 400, w: 1, h: 25 },
                    { type: 'river', x: 0.2, y: 250, w: 0.6, h: 20 },
                    { type: 'river', x: 0.1, y: 120, w: 0.8, h: 30 },
                    
                    // æ°‘å®¶ - é›†è½ã®ã‚ˆã†ã«é…ç½®
                    { type: 'house', x: 0.15, y: 420, w: 25, h: 30 },
                    { type: 'house', x: 0.18, y: 440, w: 22, h: 28 },
                    { type: 'house', x: 0.22, y: 430, w: 24, h: 32 },
                    
                    { type: 'house', x: 0.45, y: 280, w: 26, h: 29 },
                    { type: 'house', x: 0.48, y: 300, w: 23, h: 31 },
                    
                    { type: 'house', x: 0.7, y: 150, w: 25, h: 30 },
                    { type: 'house', x: 0.73, y: 170, w: 22, h: 28 },
                    { type: 'house', x: 0.68, y: 180, w: 24, h: 29 },
                    
                    { type: 'house', x: 0.3, y: 60, w: 23, h: 27 },
                    { type: 'house', x: 0.55, y: 100, w: 26, h: 31 },
                    { type: 'house', x: 0.8, y: 40, w: 24, h: 28 },
                    
                    // é“è·¯ - ç¸¦æ¨ªã®é“è·¯
                    { type: 'road', x: 0.25, y: 0, w: 20, h: 600 },
                    { type: 'road', x: 0.65, y: 0, w: 18, h: 600 },
                    { type: 'road', x: 0, y: 200, w: 1, h: 15 },
                    { type: 'road', x: 0, y: 350, w: 1, h: 12 },
                    
                    // æ£® - æ•£åœ¨ã™ã‚‹æ£®
                    { type: 'forest', x: 0.05, y: 480, w: 50, h: 50 },
                    { type: 'forest', x: 0.82, y: 420, w: 45, h: 45 },
                    { type: 'forest', x: 0.12, y: 300, w: 40, h: 40 },
                    { type: 'forest', x: 0.75, y: 280, w: 55, h: 55 },
                    { type: 'forest', x: 0.03, y: 150, w: 48, h: 48 },
                    { type: 'forest', x: 0.85, y: 120, w: 42, h: 42 },
                    { type: 'forest', x: 0.4, y: 50, w: 50, h: 50 },
                ];

                elements.forEach(element => {
                    const groundElement = document.createElement('div');
                    groundElement.className = `ground-element ${element.type}`;
                    
                    // ç›¸å¯¾åº§æ¨™ã‚’çµ¶å¯¾åº§æ¨™ã«å¤‰æ›
                    const left = element.x * windowWidth;
                    const width = element.type === 'road' && element.w === 1 ? windowWidth : 
                                  element.type === 'river' && element.w === 1 ? windowWidth :
                                  element.w < 1 ? element.w * windowWidth : element.w;
                    
                    groundElement.style.left = left + 'px';
                    groundElement.style.top = element.y + 'px';
                    groundElement.style.width = width + 'px';
                    groundElement.style.height = element.h + 'px';
                    
                    this.groundBackground.appendChild(groundElement);
                    this.groundElements.push(groundElement);
                });
            }

            createCloud() {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚µã‚¤ã‚ºã¨ä½ç½®
                const width = 60 + Math.random() * 50; // 60-110px
                const height = 25 + Math.random() * 25; // 25-50px
                const left = Math.random() * 90; // 0-90%
                
                cloud.style.width = width + 'px';
                cloud.style.height = height + 'px';
                cloud.style.top = '-150px';
                cloud.style.left = left + '%';
                cloud.style.position = 'absolute';
                cloud.style.background = 'white';
                cloud.style.borderRadius = '50px';
                cloud.style.opacity = '0.7';
                cloud.style.zIndex = '2';
                
                // beforeç–‘ä¼¼è¦ç´ ã®ä»£ã‚ã‚Šã«å­è¦ç´ ã‚’ä½œæˆ
                const before = document.createElement('div');
                const beforeWidth = width * 0.7;
                const beforeHeight = beforeWidth;
                before.style.width = beforeWidth + 'px';
                before.style.height = beforeHeight + 'px';
                before.style.position = 'absolute';
                before.style.background = 'white';
                before.style.borderRadius = '50px';
                before.style.top = (-beforeHeight/2) + 'px';
                before.style.left = (width * 0.3) + 'px';
                
                cloud.appendChild(before);
                document.getElementById('gameContainer').appendChild(cloud);
                this.clouds.push(cloud);
            }

            updateClouds() {
                // æ—¢å­˜ã®é›²ã‚’ä¸‹ã«ç§»å‹•
                this.clouds.forEach((cloud, index) => {
                    const currentTop = parseInt(cloud.style.top) || 0;
                    const newTop = currentTop + this.cloudSpeed;
                    cloud.style.top = newTop + 'px';
                    
                    // ç”»é¢ä¸‹ã«æ¶ˆãˆãŸé›²ã‚’å‰Šé™¤
                    if (newTop > window.innerHeight + 100) {
                        cloud.remove();
                        this.clouds.splice(index, 1);
                    }
                });
                
                // æ–°ã—ã„é›²ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆï¼ˆé »åº¦ã‚’ä¸Šã’ã‚‹ï¼‰
                if (Math.random() < 0.05) { // 5%ã®ç¢ºç‡ã§æ–°ã—ã„é›²ã‚’ç”Ÿæˆï¼ˆ2%â†’5%ï¼‰
                    this.createCloud();
                }
            }

            async initAudio() {
                try {
                    // AudioContextã¯æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã§åˆæœŸåŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
                    await this.loadSound('start', 'start.mp3');
                    await this.loadSound('kick', 'kick.mp3');
                    await this.loadSound('goal', 'goal.mp3');
                } catch (error) {
                    console.log('éŸ³å£°ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            }

            async loadSound(name, url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    this.sounds[name] = audioBuffer;
                } catch (error) {
                    console.log(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« ${url} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
                    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ã‚²ãƒ¼ãƒ ã¯ç¶šè¡Œ
                }
            }

            playSound(name) {
                try {
                    if (this.audioContext && this.sounds[name]) {
                        // AudioContextãŒåœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯å†é–‹
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        
                        const source = this.audioContext.createBufferSource();
                        source.buffer = this.sounds[name];
                        source.connect(this.audioContext.destination);
                        source.start(0);
                    }
                } catch (error) {
                    console.log(`éŸ³å£° ${name} ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
                }
            }

            bindEvents() {
                this.startButton.addEventListener('click', () => {
                    this.playSound('start'); // ãƒœã‚¿ãƒ³éŸ³ã‚’å†ç”Ÿ
                    this.startGame();
                });
                this.restartButton.addEventListener('click', () => {
                    this.playSound('start'); // ãƒœã‚¿ãƒ³éŸ³ã‚’å†ç”Ÿ
                    this.restartGame();
                });
                
                // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã®å¤‰æ›´ã‚’æ¤œçŸ¥
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => location.reload(), 500);
                });
            }

            async startGame() {
                try {
                    // AudioContextã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
                    if (!this.audioContext) {
                        await this.initAudio();
                    }
                    
                    // iOS 13+ ã®åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’æ±‚ã‚ã‚‹
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            alert('åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                    }
                    
                    // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                    if (typeof DeviceMotionEvent === 'undefined') {
                        alert('ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚PCã®å ´åˆã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    this.instructions.style.display = 'none';
                    this.isPlaying = true;
                    this.distance = 0;
                    this.velocity = 0;
                    this.throwTriggered = false;
                    this.backgroundOffset = 0;
                    this.groundOffset = 0;
                    this.shurikenScale = 1;
                    this.altitude = 0;
                    
                    // æ‰‹è£å‰£ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
                    this.shuriken.style.left = '50%';
                    this.shuriken.style.bottom = '100px';
                    this.shuriken.style.transform = 'translateX(-50%) scale(1)';
                    this.shuriken.querySelector('.shuriken-star').classList.remove('rotating');
                    
                    // èƒŒæ™¯ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
                    this.background.style.transform = 'translateY(0)';
                    this.groundBackground.style.transform = 'translateY(0)';
                    
                    this.distanceDisplay.textContent = 'è·é›¢: 0m';
                    
                    // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    window.addEventListener('devicemotion', (e) => this.handleMotion(e), { passive: true });
                    
                } catch (error) {
                    console.error('ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚²ãƒ¼ãƒ ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                }
            }

            handleMotion(event) {
                if (!this.isPlaying) return;
                
                const acceleration = event.accelerationIncludingGravity;
                if (!acceleration) return;
                
                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;
                
                // åŠ é€Ÿåº¦ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                this.accelXDisplay.textContent = x.toFixed(2);
                this.accelYDisplay.textContent = y.toFixed(2);
                this.accelZDisplay.textContent = z.toFixed(2);
                
                // æ¨ªæ–¹å‘ã®åŠ é€Ÿåº¦å¤‰åŒ–ã‚’æ¤œçŸ¥ï¼ˆæ‰‹è£å‰£æŠ•ã’ã®ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const deltaX = Math.abs(x - this.lastAcceleration.x);
                const deltaY = Math.abs(y - this.lastAcceleration.y);
                
                // ç´ æ—©ã„æ¨ªæŒ¯ã‚Šã‚’æ¤œçŸ¥ï¼ˆé–¾å€¤ã‚’èª¿æ•´ï¼‰
                if ((deltaX > 5 || deltaY > 5) && !this.throwTriggered) {
                    this.throwTriggered = true;
                    const power = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), 20);
                    this.throwShuriken(power);
                }
                
                this.lastAcceleration = { x, y, z };
            }

            throwShuriken(power) {
                // æŠ•ã’ã‚‹åŠ›ã«åŸºã¥ã„ã¦åˆæœŸé€Ÿåº¦ã‚’è¨­å®šï¼ˆã‚ˆã‚Šå¤§ããªå€¤ï¼‰
                this.velocity = power * 5;
                
                // æ‰‹è£å‰£æŠ•ã’éŸ³ã‚’å†ç”Ÿ
                this.playSound('kick');
                
                // æ‰‹è£å‰£ã‚’å›è»¢ã•ã›ã‚‹
                this.shuriken.querySelector('.shuriken-star').classList.add('rotating');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                this.animateShuriken();
            }

            animateShuriken() {
                const animate = () => {
                    if (!this.isPlaying) return;
                    
                    // è·é›¢ã‚’å¢—åŠ ï¼ˆã‚ˆã‚Šå¤§ããï¼‰
                    this.distance += this.velocity * 0.5;
                    this.altitude += this.velocity * 0.2; // é«˜åº¦ä¸Šæ˜‡ç‡ã‚’æ¸›å°‘ï¼ˆ0.3â†’0.2ï¼‰
                    
                    // é€Ÿåº¦ã‚’æ¸›å°‘ï¼ˆã‚ˆã‚Šå¼·ã„æ¸›è¡°ã§çŸ­æ™‚é–“é£›è¡Œï¼‰
                    this.velocity *= 0.99; // ã‚ˆã‚Šå¼·ã„æ¸›è¡°ï¼ˆ0.996â†’0.99ï¼‰
                    
                    // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼ˆæ‰‹è£å‰£ã®é€Ÿåº¦ã«å¿œã˜ã¦ï¼‰- ä¸‹æ–¹å‘ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    this.backgroundOffset += this.velocity * 1.5;
                    this.background.style.transform = `translateY(${this.backgroundOffset}px)`;
                    
                    // åœ°ä¸ŠèƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆé›²ã‚ˆã‚Šé…ãä¸‹å‘ãã«ï¼‰
                    this.groundOffset += this.groundSpeed;
                    this.groundBackground.style.transform = `translateY(${this.groundOffset}px)`;
                    
                    // é›²ã‚’æ›´æ–°
                    this.updateClouds();
                    
                    // æ‰‹è£å‰£ã®ã‚µã‚¤ã‚ºå¤‰åŒ–ï¼ˆé è¿‘æ„Ÿï¼‰- çŸ­æ™‚é–“é£›è¡Œ
                    const maxAltitude = 6000; // æœ€é«˜é«˜åº¦ã‚’åŠåˆ†ã«æ¸›å°‘ï¼ˆ8000â†’4000ï¼‰
                    const progress = Math.min(this.altitude / maxAltitude, 1);
                    
                    if (progress < 0.2) {
                        // ä¸Šæ˜‡åˆæœŸï¼šå¾ã€…ã«å¤§ãããªã‚‹
                        this.shurikenScale = 1 + progress * 7.5; // 1 â†’ 2.5
                    } else if (progress < 0.8) {
                        // ä¸Šæ˜‡ä¸­æœŸã€œæœ€é«˜ç‚¹ï¼šæœ€å¤§ã‚µã‚¤ã‚ºã‚’ç¶­æŒ
                        this.shurikenScale = 2.5 + Math.sin((progress - 0.2) * Math.PI * 1.5) * 0.3; // 2.2ã€œ2.8ã§æŒ¯å‹•
                    } else {
                        // ä¸‹é™ä¸­ï¼šå¾ã€…ã«å°ã•ããªã‚‹
                        const descendProgress = (progress - 0.8) / 0.2;
                        this.shurikenScale = 2.5 - descendProgress * 2.2; // 2.5 â†’ 0.3
                    }
                    
                    // æ‰‹è£å‰£ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚ˆã‚Šå¤§ããªæ”¾ç‰©ç·šè»Œé“ï¼‰
                    const screenHeight = window.innerHeight;
                    const verticalProgress = Math.sin(progress * Math.PI * 0.9); // ã‚ˆã‚Šç·©ã‚„ã‹ãªå¼§
                    const maxHeight = screenHeight * 0.7; // ç”»é¢ã®70%ã¾ã§ä¸Šæ˜‡
                    const y = 100 + (verticalProgress * maxHeight);
                    
                    this.shuriken.style.bottom = Math.max(50, y) + 'px';
                    this.shuriken.style.transform = `translateX(-50%) scale(${this.shurikenScale})`;
                    
                    // è»Œè·¡ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ï¼ˆé »åº¦ã‚’ä¸Šã’ã‚‹ï¼‰
                    if (Math.random() < 0.8) { // 80%ã®ç¢ºç‡ã§è»Œè·¡ã‚’è¿½åŠ 
                        const rect = this.shuriken.getBoundingClientRect();
                        this.addTrail(rect.left + rect.width/2, rect.top + rect.height/2);
                    }
                    
                    // è·é›¢ã‚’è¡¨ç¤º
                    this.distanceDisplay.textContent = `è·é›¢: ${Math.floor(this.distance)}m`;
                    
                    // æ‰‹è£å‰£ãŒç€åœ°ã™ã‚‹ã‹ã€é€Ÿåº¦ãŒååˆ†å°ã•ããªã£ãŸã‚‰çµ‚äº†
                    if (this.altitude > maxAltitude || this.velocity < 1) { // çµ‚äº†é€Ÿåº¦ã‚’ä¸Šã’ã‚‹ï¼ˆ1â†’2ï¼‰
                        this.endGame();
                        return;
                    }
                    
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            addTrail(x, y) {
                const trail = document.createElement('div');
                trail.className = 'trail';
                trail.style.left = x + 'px';
                trail.style.top = y + 'px';
                trail.style.transform = `scale(${this.shurikenScale * 0.5})`;
                
                document.getElementById('gameContainer').appendChild(trail);
                this.trails.push(trail);
                
                // è»Œè·¡ã‚’å¾ã€…ã«æ¶ˆã™
                setTimeout(() => {
                    trail.style.opacity = '0';
                    trail.style.transition = 'opacity 0.8s';
                    setTimeout(() => {
                        if (trail.parentNode) {
                            trail.parentNode.removeChild(trail);
                        }
                        const index = this.trails.indexOf(trail);
                        if (index > -1) {
                            this.trails.splice(index, 1);
                        }
                    }, 800);
                }, 50);
            }

            endGame() {
                this.isPlaying = false;
                
                // ç€åœ°éŸ³ã‚’å†ç”Ÿ
                this.playSound('goal');
                
                // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                window.removeEventListener('devicemotion', this.handleMotion);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                // æ‰‹è£å‰£ã®å›è»¢ã‚’åœæ­¢
                this.shuriken.querySelector('.shuriken-star').classList.remove('rotating');
                
                // æœ€çµ‚è·é›¢
                const finalDistance = Math.floor(this.distance);
                document.getElementById('finalDistance').textContent = `è·é›¢: ${finalDistance}m`;
                
                // ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯
                const newRecord = document.getElementById('newRecord');
                if (finalDistance > this.maxDistance) {
                    this.maxDistance = finalDistance;
                    localStorage.setItem('maxDistance', this.maxDistance);
                    this.maxDistanceDisplay.textContent = `æœ€é«˜è¨˜éŒ²: ${this.maxDistance}m`;
                    newRecord.style.display = 'block';
                } else {
                    newRecord.style.display = 'none';
                }
                
                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º
                this.gameOver.style.display = 'block';
            }

            restartGame() {
                // è»Œè·¡ã‚’ã‚¯ãƒªã‚¢
                this.trails.forEach(trail => {
                    if (trail.parentNode) {
                        trail.parentNode.removeChild(trail);
                    }
                });
                this.trails = [];
                
                // å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸé›²ã‚’ã‚¯ãƒªã‚¢
                this.clouds.forEach(cloud => {
                    if (cloud.parentNode && !cloud.className.includes('cloud1') && !cloud.className.includes('cloud2') && !cloud.className.includes('cloud3')) {
                        cloud.remove();
                    }
                });
                
                // åˆæœŸé›²ã‚’ãƒªã‚»ãƒƒãƒˆ
                this.initClouds();
                document.querySelector('.cloud1').style.top = '-100px';
                document.querySelector('.cloud2').style.top = '-150px';
                document.querySelector('.cloud3').style.top = '-200px';
                
                // èƒŒæ™¯ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
                this.background.style.transform = 'translateY(0)';
                this.groundBackground.style.transform = 'translateY(0)';
                
                this.gameOver.style.display = 'none';
                this.instructions.style.display = 'block';
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        window.addEventListener('load', () => {
            new ShurikenGame();
        });
    </script>
</body>
</html>