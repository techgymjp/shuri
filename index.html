<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手裏剣シュシュシュ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            overflow: hidden;
            user-select: none;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 500%;
            background: linear-gradient(180deg, 
                #000428 0%, 
                #004e92 10%, 
                #009ffd 20%, 
                #00d2ff 30%, 
                #87CEEB 40%, 
                #87CEEB 50%, 
                #98FB98 60%, 
                #98FB98 70%, 
                #F0E68C 80%, 
                #DEB887 90%, 
                #8B7355 100%);
            z-index: 1;
            transition: transform 0.1s ease-out;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.7;
            z-index: 2;
        }

        .cloud:before {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50px;
        }

        /* 雲を画面内の適切な位置に配置 */
        .cloud1 {
            width: 60px;
            height: 30px;
            top: 15%;
            left: 20%;
        }

        .cloud1:before {
            width: 40px;
            height: 40px;
            top: -20px;
            left: 10px;
        }

        .cloud2 {
            width: 80px;
            height: 40px;
            top: 25%;
            left: 70%;
        }

        .cloud2:before {
            width: 60px;
            height: 60px;
            top: -30px;
            left: 20px;
        }

        .cloud3 {
            width: 100px;
            height: 50px;
            top: 35%;
            left: 40%;
        }

        .cloud3:before {
            width: 80px;
            height: 80px;
            top: -40px;
            left: 20px;
        }

        .cloud4 {
            width: 70px;
            height: 35px;
            top: 45%;
            left: 10%;
        }

        .cloud4:before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 15px;
        }

        .cloud5 {
            width: 90px;
            height: 45px;
            top: 55%;
            left: 60%;
        }

        .cloud5:before {
            width: 70px;
            height: 70px;
            top: -35px;
            left: 15px;
        }

        .cloud6 {
            width: 75px;
            height: 38px;
            top: 65%;
            left: 25%;
        }

        .cloud6:before {
            width: 55px;
            height: 55px;
            top: -28px;
            left: 12px;
        }

        .cloud7 {
            width: 85px;
            height: 42px;
            top: 120%;
            left: 80%;
        }

        .cloud7:before {
            width: 65px;
            height: 65px;
            top: -32px;
            left: 18px;
        }

        .cloud8 {
            width: 95px;
            height: 48px;
            top: 150%;
            left: 15%;
        }

        .cloud8:before {
            width: 75px;
            height: 75px;
            top: -38px;
            left: 20px;
        }

        /* 追加の雲 */
        .cloud9 {
            width: 65px;
            height: 32px;
            top: 180%;
            left: 50%;
        }

        .cloud9:before {
            width: 45px;
            height: 45px;
            top: -22px;
            left: 12px;
        }

        .cloud10 {
            width: 110px;
            height: 55px;
            top: 250%;
            left: 30%;
        }

        .cloud10:before {
            width: 85px;
            height: 85px;
            top: -42px;
            left: 25px;
        }

        .mountain {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: 2;
        }

        /* 山を適切な位置に配置 */
        .mountain1 {
            left: 10%;
            bottom: 0;
            border-left: 80px solid transparent;
            border-right: 80px solid transparent;
            border-bottom: 120px solid #2d5016;
        }

        .mountain2 {
            left: 40%;
            bottom: 0;
            border-left: 100px solid transparent;
            border-right: 100px solid transparent;
            border-bottom: 150px solid #1a3009;
        }

        .mountain3 {
            right: 20%;
            bottom: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-bottom: 90px solid #2d5016;
        }

        .mountain4 {
            left: 70%;
            bottom: 0;
            border-left: 70px solid transparent;
            border-right: 70px solid transparent;
            border-bottom: 110px solid #1a3009;
        }

        .mountain5 {
            left: 25%;
            bottom: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 80px solid #2d5016;
        }

        .mountain6 {
            right: 45%;
            bottom: 0;
            border-left: 90px solid transparent;
            border-right: 90px solid transparent;
            border-bottom: 140px solid #1a3009;
        }

        /* 背景の下部に追加の山 */
        .mountain7 {
            left: 5%;
            top: 450%;
            border-left: 120px solid transparent;
            border-right: 120px solid transparent;
            border-bottom: 200px solid #1a3009;
        }

        .mountain8 {
            right: 10%;
            top: 470%;
            border-left: 100px solid transparent;
            border-right: 100px solid transparent;
            border-bottom: 160px solid #2d5016;
        }

        #shuriken {
            position: absolute;
            width: 40px;
            height: 40px;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            z-index: 10;
            transition: none;
        }

        .shuriken-star {
            width: 100%;
            height: 100%;
            background: #333;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .rotating {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 20px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
        }

        #instructions h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #FFD700;
        }

        #instructions p {
            font-size: 1.2em;
            margin: 10px 0;
            line-height: 1.5;
        }

        #startButton {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: transform 0.2s;
        }

        #startButton:hover {
            transform: translateY(-2px);
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            display: none;
        }

        #distance {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        #maxDistance {
            font-size: 1.2em;
            color: #FFD700;
            margin-bottom: 20px;
        }

        #restartButton {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
            transition: transform 0.2s;
        }

        #restartButton:hover {
            transform: translateY(-2px);
        }

        #accelerationDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 16px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #FFD700, transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="background">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            <div class="cloud cloud3"></div>
            <div class="cloud cloud4"></div>
            <div class="cloud cloud5"></div>
            <div class="cloud cloud6"></div>
            <div class="cloud cloud7"></div>
            <div class="cloud cloud8"></div>
            <div class="cloud cloud9"></div>
            <div class="cloud cloud10"></div>
            <div class="mountain mountain1"></div>
            <div class="mountain mountain2"></div>
            <div class="mountain mountain3"></div>
            <div class="mountain mountain4"></div>
            <div class="mountain mountain5"></div>
            <div class="mountain mountain6"></div>
            <div class="mountain mountain7"></div>
            <div class="mountain mountain8"></div>
        </div>

        <div id="instructions">
            <h1>🥷 手裏剣シュシュシュ 🥷</h1>
            <p>デバイスを水平に持って、横に素早く振ってください！</p>
            <p>加速度に応じて手裏剣が遠くまで飛びます</p>
            <p>最高記録を目指しましょう！</p>
            <button id="startButton">ゲーム開始</button>
        </div>

        <div id="ui">
            <div id="distance">距離: 0m</div>
            <div id="maxDistance">最高記録: 0m</div>
        </div>

        <div id="shuriken">
            <div class="shuriken-star"></div>
        </div>

        <div id="gameOver">
            <h2>🎯 結果発表 🎯</h2>
            <div id="finalDistance">距離: 0m</div>
            <div id="newRecord" style="display: none; color: #FFD700; font-size: 1.5em; margin: 10px 0;">🎉 新記録！ 🎉</div>
            <button id="restartButton">もう一度挑戦</button>
        </div>

        <div id="accelerationDisplay">
            <div>加速度 X: <span id="accelX">0</span></div>
            <div>加速度 Y: <span id="accelY">0</span></div>
            <div>加速度 Z: <span id="accelZ">0</span></div>
        </div>
    </div>

    <script>
        class ShurikenGame {
            constructor() {
                this.shuriken = document.getElementById('shuriken');
                this.background = document.getElementById('background');
                this.distanceDisplay = document.getElementById('distance');
                this.maxDistanceDisplay = document.getElementById('maxDistance');
                this.instructions = document.getElementById('instructions');
                this.gameOver = document.getElementById('gameOver');
                this.startButton = document.getElementById('startButton');
                this.restartButton = document.getElementById('restartButton');
                
                this.accelXDisplay = document.getElementById('accelX');
                this.accelYDisplay = document.getElementById('accelY');
                this.accelZDisplay = document.getElementById('accelZ');
                
                this.isPlaying = false;
                this.distance = 0;
                this.velocity = 0;
                this.maxDistance = parseInt(localStorage.getItem('maxDistance')) || 0;
                this.lastAcceleration = { x: 0, y: 0, z: 0 };
                this.throwTriggered = false;
                this.animationId = null;
                this.trails = [];
                this.backgroundOffset = 0;
                this.shurikenScale = 1;
                this.altitude = 0;
                
                // 音声関連
                this.audioContext = null;
                this.sounds = {};
                
                this.maxDistanceDisplay.textContent = `最高記録: ${this.maxDistance}m`;
                
                this.bindEvents();
                this.initAudio();
            }

            async initAudio() {
                try {
                    // AudioContextは最初のユーザーインタラクションで初期化する必要がある
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // 音声ファイルをプリロード
                    await this.loadSound('start', 'start.mp3');
                    await this.loadSound('kick', 'kick.mp3');
                    await this.loadSound('goal', 'goal.mp3');
                } catch (error) {
                    console.log('音声の初期化に失敗しました:', error);
                }
            }

            async loadSound(name, url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    this.sounds[name] = audioBuffer;
                } catch (error) {
                    console.log(`音声ファイル ${url} の読み込みに失敗しました:`, error);
                    // 音声ファイルが見つからない場合でもゲームは続行
                }
            }

            playSound(name) {
                try {
                    if (this.audioContext && this.sounds[name]) {
                        // AudioContextが停止している場合は再開
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        
                        const source = this.audioContext.createBufferSource();
                        source.buffer = this.sounds[name];
                        source.connect(this.audioContext.destination);
                        source.start(0);
                    }
                } catch (error) {
                    console.log(`音声 ${name} の再生に失敗しました:`, error);
                }
            }

            bindEvents() {
                this.startButton.addEventListener('click', () => {
                    this.playSound('start'); // ボタン音を再生
                    this.startGame();
                });
                this.restartButton.addEventListener('click', () => {
                    this.playSound('start'); // ボタン音を再生
                    this.restartGame();
                });
                
                // デバイスの向きの変更を検知
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => location.reload(), 500);
                });
            }

            async startGame() {
                try {
                    // AudioContextを初期化（ユーザーインタラクション後）
                    if (!this.audioContext) {
                        await this.initAudio();
                    }
                    
                    // 加速度センサーの許可を求める
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            alert('加速度センサーの許可が必要です');
                            return;
                        }
                    }
                    
                    this.instructions.style.display = 'none';
                    this.isPlaying = true;
                    this.distance = 0;
                    this.velocity = 0;
                    this.throwTriggered = false;
                    this.backgroundOffset = 0;
                    this.shurikenScale = 1;
                    this.altitude = 0;
                    
                    // 手裏剣を初期位置に戻す
                    this.shuriken.style.left = '50%';
                    this.shuriken.style.bottom = '100px';
                    this.shuriken.style.transform = 'translateX(-50%) scale(1)';
                    this.shuriken.querySelector('.shuriken-star').classList.remove('rotating');
                    
                    // 背景を初期位置に戻す
                    this.background.style.transform = 'translateY(0)';
                    
                    this.distanceDisplay.textContent = '距離: 0m';
                    
                    // 加速度センサーのリスナーを追加
                    window.addEventListener('devicemotion', (e) => this.handleMotion(e));
                    
                } catch (error) {
                    alert('このデバイスは加速度センサーに対応していません');
                }
            }

            handleMotion(event) {
                if (!this.isPlaying) return;
                
                const acceleration = event.accelerationIncludingGravity;
                if (!acceleration) return;
                
                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;
                
                // 加速度を表示（デバッグ用）
                this.accelXDisplay.textContent = x.toFixed(2);
                this.accelYDisplay.textContent = y.toFixed(2);
                this.accelZDisplay.textContent = z.toFixed(2);
                
                // 横方向の加速度変化を検知（手裏剣投げのモーション）
                const deltaX = Math.abs(x - this.lastAcceleration.x);
                const deltaY = Math.abs(y - this.lastAcceleration.y);
                
                // 素早い横振りを検知（閾値を調整）
                if ((deltaX > 5 || deltaY > 5) && !this.throwTriggered) {
                    this.throwTriggered = true;
                    const power = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), 20);
                    this.throwShuriken(power);
                }
                
                this.lastAcceleration = { x, y, z };
            }

            throwShuriken(power) {
                // 投げる力に基づいて初期速度を設定（より大きな値）
                this.velocity = power * 5;
                
                // 手裏剣投げ音を再生
                this.playSound('kick');
                
                // 手裏剣を回転させる
                this.shuriken.querySelector('.shuriken-star').classList.add('rotating');
                
                // アニメーションを開始
                this.animateShuriken();
            }

            animateShuriken() {
                const animate = () => {
                    if (!this.isPlaying) return;
                    
                    // 距離を増加（より大きく）
                    this.distance += this.velocity * 0.5;
                    this.altitude += this.velocity * 0.3; // 高度上昇を大幅に減少
                    
                    // 速度を適度に減少（長時間飛行）
                    this.velocity *= 0.996; // より強い減衰
                    
                    // 背景のスクロール速度（手裏剣の速度に応じて）
                    this.backgroundOffset += this.velocity * 1.5;
                    this.background.style.transform = `translateY(${this.backgroundOffset}px)`;
                    
                    // 手裏剣のサイズ変化（遠近感）- より長い飛行時間
                    const maxAltitude = 8000; // 最高高度を大幅に増加
                    const progress = Math.min(this.altitude / maxAltitude, 1);
                    
                    if (progress < 0.2) {
                        // 上昇初期：徐々に大きくなる
                        this.shurikenScale = 1 + progress * 7.5; // 1 → 2.5
                    } else if (progress < 0.8) {
                        // 上昇中期〜最高点：最大サイズを維持
                        this.shurikenScale = 2.5 + Math.sin((progress - 0.2) * Math.PI * 1.5) * 0.3; // 2.2〜2.8で振動
                    } else {
                        // 下降中：徐々に小さくなる
                        const descendProgress = (progress - 0.8) / 0.2;
                        this.shurikenScale = 2.5 - descendProgress * 2.2; // 2.5 → 0.3
                    }
                    
                    // 手裏剣の位置を更新（より大きな放物線軌道）
                    const screenHeight = window.innerHeight;
                    const verticalProgress = Math.sin(progress * Math.PI * 0.9); // より緩やかな弧
                    const maxHeight = screenHeight * 0.7; // 画面の70%まで上昇
                    const y = 100 + (verticalProgress * maxHeight);
                    
                    this.shuriken.style.bottom = Math.max(50, y) + 'px';
                    this.shuriken.style.transform = `translateX(-50%) scale(${this.shurikenScale})`;
                    
                    // 軌跡エフェクトを追加（頻度を上げる）
                    if (Math.random() < 0.8) { // 80%の確率で軌跡を追加
                        const rect = this.shuriken.getBoundingClientRect();
                        this.addTrail(rect.left + rect.width/2, rect.top + rect.height/2);
                    }
                    
                    // 距離を表示
                    this.distanceDisplay.textContent = `距離: ${Math.floor(this.distance)}m`;
                    
                    // 手裏剣が着地するか、速度が十分小さくなったら終了
                    if (this.altitude > maxAltitude || this.velocity < 1) {
                        this.endGame();
                        return;
                    }
                    
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            addTrail(x, y) {
                const trail = document.createElement('div');
                trail.className = 'trail';
                trail.style.left = x + 'px';
                trail.style.top = y + 'px';
                trail.style.transform = `scale(${this.shurikenScale * 0.5})`;
                
                document.getElementById('gameContainer').appendChild(trail);
                this.trails.push(trail);
                
                // 軌跡を徐々に消す
                setTimeout(() => {
                    trail.style.opacity = '0';
                    trail.style.transition = 'opacity 0.8s';
                    setTimeout(() => {
                        if (trail.parentNode) {
                            trail.parentNode.removeChild(trail);
                        }
                        const index = this.trails.indexOf(trail);
                        if (index > -1) {
                            this.trails.splice(index, 1);
                        }
                    }, 800);
                }, 50);
            }

            endGame() {
                this.isPlaying = false;
                
                // 着地音を再生
                this.playSound('goal');
                
                // 加速度センサーのリスナーを削除
                window.removeEventListener('devicemotion', this.handleMotion);
                
                // アニメーションを停止
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                // 手裏剣の回転を停止
                this.shuriken.querySelector('.shuriken-star').classList.remove('rotating');
                
                // 最終距離
                const finalDistance = Math.floor(this.distance);
                document.getElementById('finalDistance').textContent = `距離: ${finalDistance}m`;
                
                // ハイスコアチェック
                const newRecord = document.getElementById('newRecord');
                if (finalDistance > this.maxDistance) {
                    this.maxDistance = finalDistance;
                    localStorage.setItem('maxDistance', this.maxDistance);
                    this.maxDistanceDisplay.textContent = `最高記録: ${this.maxDistance}m`;
                    newRecord.style.display = 'block';
                } else {
                    newRecord.style.display = 'none';
                }
                
                // ゲームオーバー画面を表示
                this.gameOver.style.display = 'block';
            }

            restartGame() {
                // 軌跡をクリア
                this.trails.forEach(trail => {
                    if (trail.parentNode) {
                        trail.parentNode.removeChild(trail);
                    }
                });
                this.trails = [];
                
                // 背景を初期位置に戻す
                this.background.style.transform = 'translateY(0)';
                
                this.gameOver.style.display = 'none';
                this.instructions.style.display = 'block';
            }
        }

        // ゲーム開始
        window.addEventListener('load', () => {
            new ShurikenGame();
        });
    </script>
</body>
</html>